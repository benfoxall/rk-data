<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>RK Data</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="container">
      <header>

        {{^user}}

          <p>
            <a href="/auth/runkeeper">sign in with runkeeper</a>
          </p>
        {{/user}}

        {{#user}}
          <img class="avatar" src="/picture" width="72" height="72">
          <h3>
            {{name}} {{_id}}
          </h3>
          <p>
            <a href="/logout">sign out</a>
          </p>
        {{/user}}
      </header>




      {{#user}}
        <button id="request">Request (all) </button> <button id="fill">Fill (50)</button> <button id="destroy">destroy</button>

        <pre id="output"></pre>

        <script type="text/javascript" src="bower_components/reqwest/reqwest.min.js"></script>
        <script type="text/javascript" src="bower_components/dexie/dist/latest/Dexie.min.js"></script>
        <script type="text/javascript">


          var db = new Dexie("Runkeeper");
          db.version(1).stores({
            activities: "&uri,total_distance,userID,start_time_norm"
          });
          db.version(2).stores({
            activities: "&uri",
            summaries: "&id, userID, uri, state"
          });
          db.open();



          // function Activity() {
          //
          // }
          //
          // function Summary() {
          //
          // }
          //
          //
          // db.summaries.mapToClass(Summary, {
          //   id: String,
          //   userID: Number,
          //   uri: String,
          //   state: String,
          //   // unindexed
          //   title: String,
          // })


          function populate(url, count) {

            reqwest('/data' + url)
              .then(function(res){
                if(res.next && count > 0){
                    populate(res.next, count - 1)
                }

                res.items.forEach(function(item){

                  db
                    .summaries
                    .add(indexToSummary(item))
                    .catch(function(e){
                      if(e.name == 'ConstraintError'){
                        console.log('duplicate')
                      } else {
                        console.log(e);
                      }
                    })
                });

                render()
              })
          }



          // converter things

          function indexToSummary(item){
            var start = new Date(item.start_time).getTime();
            return {
              id: start + '-' + item.uri,
              userId: {{_id}},
              time: start,
              uri: item.uri,
              state: 'new',

              label: {
                type: item.type,
                duration: item.duration,
                distance: item.total_distance,
                start_time: item.start_time
              }
            }
          }




          function render(){
            console.time('render')
            var htm = '';
            db
              .summaries
              .reverse()
              .each(function(item, cursor){
                htm += summaryToHTML(item);
              })
              .then(function(){
                output.innerText = htm;
                console.timeEnd('render')
              })
              .catch(console.error.bind(console));
          }

          render();


          // pull in the full data for an activity
          function fill(id){

            return db.summaries
                .where('uri')
                .equals(id)
                .modify({state: 'requesting'})
              .then(function(){
                return reqwest('data' + id)
              })
              .then(function(data){
                console.log(data)
                return db.activities.put(data)
              })
              .then(function(data){
                db.summaries
                    .where('uri')
                    .equals(id)
                    .modify({state: 'success'})
              })
              .then(function (updated) {
                  if (updated)
                      console.log ("updated " + id);
                  else
                      console.log ("NOT updated " + id);
              })
              .catch(function(r){
                console.log("ERROR", r)
              });
          }


          // hacky test
          function fillSome(n){
            db
              .summaries
              .where('state')
              .equals('new')
              .reverse()
              .limit(n)
              .each(function(item, cursor){
                fill(item.uri).then(render)
              })
              .catch(console.error.bind(console));
          }

          // fill('/fitnessActivities/142038704');

            function summaryToHTML(i){
              return [
                  i.label.type,
                  (i.label.distance/1000).toPrecision(2) + 'km',
                  i.label.start_time,
                  i.uri,
                  i.state
                ].join('\t') + '\n';
            }


            document.getElementById('request').addEventListener('click', function(e){
              populate('/fitnessActivities', 20)
            }, false);


            document.getElementById('fill').addEventListener('click', function(e){
              fillSome(50);
            }, false);

            document.getElementById('destroy').addEventListener('click', function(e){
              db.summaries.clear()
                .then(function(){return db.activities.clear()})
                .then(function(){render()})
            }, false)

        </script>
      {{/user}}

    </div>

  </body>
</html>
