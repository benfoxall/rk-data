<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>RK Data</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <svg style="position: absolute; width: 0; height: 0;" width="0" height="0" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <defs>
      <symbol id="icon-loading" viewBox="0 0 1024 1024">
      	<title>loading</title>
      	<path class="path1" d="M1024 512c-1.278-66.862-15.784-133.516-42.576-194.462-26.704-61-65.462-116.258-113.042-161.92-47.552-45.696-103.944-81.82-164.984-105.652-61.004-23.924-126.596-35.352-191.398-33.966-64.81 1.282-129.332 15.374-188.334 41.356-59.048 25.896-112.542 63.47-156.734 109.576-44.224 46.082-79.16 100.708-102.186 159.798-23.114 59.062-34.128 122.52-32.746 185.27 1.286 62.76 14.964 125.148 40.134 182.206 25.088 57.1 61.476 108.828 106.11 151.548 44.61 42.754 97.472 76.504 154.614 98.72 57.118 22.304 118.446 32.902 179.142 31.526 60.708-1.29 120.962-14.554 176.076-38.914 55.15-24.282 105.116-59.48 146.366-102.644 41.282-43.14 73.844-94.236 95.254-149.43 13.034-33.458 21.88-68.4 26.542-103.798 1.246 0.072 2.498 0.12 3.762 0.12 35.346 0 64-28.652 64-64 0-1.796-0.094-3.572-0.238-5.332h0.238zM922.306 681.948c-23.472 53.202-57.484 101.4-99.178 141.18-41.67 39.81-91 71.186-144.244 91.79-53.228 20.678-110.29 30.452-166.884 29.082-56.604-1.298-112.596-13.736-163.82-36.474-51.25-22.666-97.684-55.49-135.994-95.712-38.338-40.198-68.528-87.764-88.322-139.058-19.87-51.284-29.228-106.214-27.864-160.756 1.302-54.552 13.328-108.412 35.254-157.69 21.858-49.3 53.498-93.97 92.246-130.81 38.73-36.868 84.53-65.87 133.874-84.856 49.338-19.060 102.136-28.006 154.626-26.644 52.5 1.306 104.228 12.918 151.562 34.034 47.352 21.050 90.256 51.502 125.624 88.782 35.396 37.258 63.21 81.294 81.39 128.688 18.248 47.392 26.782 98.058 25.424 148.496h0.238c-0.144 1.76-0.238 3.536-0.238 5.332 0 33.012 24.992 60.174 57.086 63.624-6.224 34.822-16.53 68.818-30.78 100.992z"></path>
      </symbol>
      <symbol id="icon-fail" viewBox="0 0 1024 1024">
      	<title>fail</title>
      	<path class="path1" d="M1014.662 822.66c-0.004-0.004-0.008-0.008-0.012-0.010l-310.644-310.65 310.644-310.65c0.004-0.004 0.008-0.006 0.012-0.010 3.344-3.346 5.762-7.254 7.312-11.416 4.246-11.376 1.824-24.682-7.324-33.83l-146.746-146.746c-9.148-9.146-22.45-11.566-33.828-7.32-4.16 1.55-8.070 3.968-11.418 7.31 0 0.004-0.004 0.006-0.008 0.010l-310.648 310.652-310.648-310.65c-0.004-0.004-0.006-0.006-0.010-0.010-3.346-3.342-7.254-5.76-11.414-7.31-11.38-4.248-24.682-1.826-33.83 7.32l-146.748 146.748c-9.148 9.148-11.568 22.452-7.322 33.828 1.552 4.16 3.97 8.072 7.312 11.416 0.004 0.002 0.006 0.006 0.010 0.010l310.65 310.648-310.65 310.652c-0.002 0.004-0.006 0.006-0.008 0.010-3.342 3.346-5.76 7.254-7.314 11.414-4.248 11.376-1.826 24.682 7.322 33.83l146.748 146.746c9.15 9.148 22.452 11.568 33.83 7.322 4.16-1.552 8.070-3.97 11.416-7.312 0.002-0.004 0.006-0.006 0.010-0.010l310.648-310.65 310.648 310.65c0.004 0.002 0.008 0.006 0.012 0.008 3.348 3.344 7.254 5.762 11.414 7.314 11.378 4.246 24.684 1.826 33.828-7.322l146.746-146.748c9.148-9.148 11.57-22.454 7.324-33.83-1.552-4.16-3.97-8.068-7.314-11.414z"></path>
      </symbol>
      <symbol id="icon-success" viewBox="0 0 1024 1024">
      	<title>success</title>
      	<path class="path1" d="M864 128l-480 480-224-224-160 160 384 384 640-640z"></path>
      </symbol>
      <symbol id="icon-ready" viewBox="0 0 1024 1024">
      	<title>ready</title>
      	<path class="path1" d="M877.254 621.254l-320 320c-24.992 24.994-65.514 24.994-90.508 0l-320-320c-24.994-24.994-24.994-65.516 0-90.51 24.994-24.996 65.516-24.996 90.51 0l210.744 210.746v-613.49c0-35.346 28.654-64 64-64s64 28.654 64 64v613.49l210.746-210.746c12.496-12.496 28.876-18.744 45.254-18.744s32.758 6.248 45.254 18.746c24.994 24.994 24.994 65.514 0 90.508z"></path>
      </symbol>
      </defs>
    </svg>

    <div class="container">
      <header>

        {{^user}}

          <p>
            <a href="/auth/runkeeper">sign in with runkeeper</a>
          </p>
        {{/user}}

        {{#user}}
          <img class="avatar" src="/picture" width="72" height="72">
          <h3>
            {{name}} {{_id}}
          </h3>
          <p>
            <a href="/logout">sign out</a>
          </p>
        {{/user}}
      </header>




      {{#user}}
        <button id="request">Request (all) </button> <button id="fill">Fill (50)</button> <button id="destroy">destroy</button>

        <div class="downloads">
          <a href="#" id="download1">summary.csv</a>
          <a href="#" id="download-distances">distances.csv</a>
          <a href="#" id="download-paths">paths.csv</a>
        </div>

        <table>
          <tbody id="activities">
          </tbody>
        </table>

        <pre id="output"></pre>

        <script type="text/javascript" src="bower_components/FileSaver/FileSaver.min.js"></script>
        <script type="text/javascript" src="bower_components/reqwest/reqwest.min.js"></script>
        <script type="text/javascript" src="bower_components/dexie/dist/latest/Dexie.min.js"></script>
        <script type="text/javascript">


          function Rows(el){
            this.el = el;
            this._map = {};
          }

          Rows.prototype.set = function(id, data, idx){
            var tr = this._map[id];

            if(!this._map[id]){
              this.el.appendChild(tr = this._map[id] = document.createElement('tr'))
            }

            if(typeof(idx) !== 'undefined'){
              // update only a particular column
              var el = tr.childNodes[idx];
              if(el) el.textContent = data;
              console.log(el, data)
              return;

            }
            // could be more efficient, but whatever
            while (tr.firstChild) tr.removeChild(tr.firstChild)

            data.forEach(function(item){
                var td = document.createElement('td');
                td.textContent = item;
                tr.appendChild(td);
            })
          }

          Rows.prototype.clear = function(){
            while (this.el.firstChild) this.el.removeChild(this.el.firstChild)
            this._map = {};
          }

          var elements = new Rows(document.getElementById('activities'));


          /*
            can be MASSIVELY simplified
              * inferring time order from ID (probably bad)
              * not displaying the full list of activities
          */
          var db = new Dexie("Runkeeper");
          db.version(1).stores({
            activities: "&uri,total_distance,userID,start_time_norm"
          });
          db.version(2).stores({
            activities: "&uri",
            summaries: "&id, userID, uri, state"
          });
          db.open();

          function populate(url, count) {

            reqwest('/data' + url)
              .then(function(res){
                if(res.next && count > 0){
                    populate(res.next, count - 1)
                }

                res.items.forEach(function(item){

                  db
                    .summaries
                    .add(indexToSummary(item))
                    .catch(function(e){
                      if(e.name == 'ConstraintError'){
                        console.log('duplicate')
                      } else {
                        console.log(e);
                      }
                    })
                });

                render()
              })
          }



          // converter things

          function summaryId(item){
            new Date(item.start_time).getTime() +  '-' + item.uri;
          }

          function indexToSummary(item){
            var start = new Date(item.start_time).getTime();
            return {
              id: start + '-' + item.uri,
              userId: {{_id}},
              time: start,
              uri: item.uri,
              state: 'new',

              label: {
                type: item.type,
                duration: item.duration,
                distance: item.total_distance,
                start_time: item.start_time
              }
            }
          }


          function renderItem(i){
            elements.set(i.uri, [
                i.label.type,
                (i.label.distance/1000).toPrecision(2) + 'km',
                i.label.start_time,
                i.uri,
                i.state
            ])
          }


          function render(){
            console.time('render')

            db
              .summaries
              .reverse()
              .each(renderItem)
              .then(console.timeEnd.bind(console,'render'))
              .catch(console.error.bind(console));
          }

          render();


          // pull in the full data for an activity
          function fill(id){

            return db.summaries
                .where('uri')
                .equals(id)
                .modify({state: 'requesting'})
              .then(function(d){
                elements.set(id, 'requesting', 4)
                return reqwest('data' + id)
              })
              .then(function(data){
                elements.set(id, 'success', 4)
                return db.activities.put(data)
              })
              .then(function(data){
                return db.summaries
                    .where('uri')
                    .equals(id)
                    .modify({state: 'success'})
              })
              .then(function (updated) {
                  if (updated)
                      console.log ("updated " + id);
                  else
                      console.log ("NOT updated " + id);
              })
              .catch(function(r){
                elements.set(id, 'error', 4)
                console.log("ERROR", r)
              });
          }


          // hacky test
          function fillSome(n){
            db
              .summaries
              .where('state')
              .equals('new')
              .reverse()
              .limit(n)
              .each(function(item, cursor){
                fill(item.uri);
              })
              .catch(console.error.bind(console));
          }

          // fill('/fitnessActivities/142038704');

            function summaryToHTML(i){
              return [
                  i.label.type,
                  (i.label.distance/1000).toPrecision(2) + 'km',
                  i.label.start_time,
                  i.uri,
                  i.state
                ].join('\t') + '\n';
            }




            document.getElementById('request').addEventListener('click', function(e){
              populate('/fitnessActivities', 20)
            }, false);


            document.getElementById('fill').addEventListener('click', function(e){
              fillSome(50);
            }, false);

            document.getElementById('destroy').addEventListener('click', function(e){
              db.summaries.clear()
                .then(function(){return db.activities.clear()})
                .then(function(){render()})
            }, false)

            document.getElementById('download1').addEventListener('click', function(e){
              e.preventDefault();

              console.time('export')

              var keys = ['uri', 'duration', 'type', 'start_time', 'total_distance', 'climb', 'total_calories'];
              var rows = [keys];

              db
                .activities
                .reverse()
                .each(function(activity){
                  rows.push(
                    row(keys, activity)
                  )
                })
                .then(function(){
                  console.timeEnd('export');

                  var b = new Blob(rows.map(function(row){
                    return csv(row) + '\n';
                  }),  {type: 'text/csv'});

                  saveAs(b, 'runkeeper-{{name}}-summary.csv')
                })


            }, false)



            document.getElementById('download-distances').addEventListener('click', function(e){
              e.preventDefault();

              console.time('export distances')

              var data = [new Blob(['uri, timestamp, distance\n'])];

              db
                .activities
                .reverse()
                .each(function(activity){
                  data.push(
                    new Blob([activity.distance.map(function(d){
                      return csv([activity.uri, d.timestamp, d.distance])
                    }).join('\n') + '\n'])
                  );
                })
                .then(function(){
                  console.timeEnd('export distances');

                  var b = new Blob(data,  {type: 'text/csv'});

                  saveAs(b, 'runkeeper-{{name}}-distances.csv')
                })


            }, false)




            document.getElementById('download-paths').addEventListener('click', function(e){
              e.preventDefault();

              console.time('export paths')

              var data = [new Blob(['uri, timestamp, altitude, latitude, longitude\n'])];

              db
                .activities
                .reverse()
                .each(function(activity){
                  data.push(
                    new Blob([activity.path.map(function(d){
                      return csv([activity.uri, d.timestamp, d.altitude, d.latitude, d.longitude])
                    }).join('\n') + '\n'])
                  );
                })
                .then(function(){
                  console.timeEnd('export paths');

                  var b = new Blob(data,  {type: 'text/csv'});

                  saveAs(b, 'runkeeper-{{name}}-paths.csv')
                })


            }, false)


            // pull out a row of keys
            function row(keys, obj){
              return keys.map(function(k){
                return obj[k]
              })
            }
            // create a csv row from an array
            function csv(array){

              // this is not a world class csv generator
              return array.map(function(item){
                return  typeof(item) === 'string' ?
                  item.replace(/[\",]/g,'') :
                  item;
              }).join(',')
            }

        </script>
      {{/user}}

    </div>

  </body>
</html>
