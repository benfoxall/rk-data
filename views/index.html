<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>RK Data</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="container">
      <header>

        {{^user}}

          <p>
            <a href="/auth/runkeeper">sign in with runkeeper</a>
          </p>
        {{/user}}

        {{#user}}
          <img class="avatar" src="/picture" width="72" height="72">
          <h3>
            {{name}} {{_id}}
          </h3>
          <p>
            <a href="/logout">sign out</a>
          </p>
        {{/user}}
      </header>




      {{#user}}
        <pre id="output"></pre>

        <script type="text/javascript" src="bower_components/reqwest/reqwest.min.js"></script>
        <script type="text/javascript" src="bower_components/dexie/dist/latest/Dexie.min.js"></script>
        <script type="text/javascript">

          var db = new Dexie("Runkeeper");
          db.version(1).stores({
            activities: "&uri,total_distance,userID,start_time_norm"
          });
          db.open();


          function list(url, count) {
            count--;

            reqwest(url)
              .then(function(res){
                if(res.next && count > 0){
                    list('/data' + res.next, count)
                }

                res.items.forEach(function(item){
                  item.userID = {{_id}};
                  item.start_time_norm = +new Date(item.start_time);

                  db
                    .activities
                    .add(item)
                    .then(function(){
                      output.innerText += row(item)
                    })
                    .catch(function(e){
                      if(e.name == 'ConstraintError'){
                        console.log('duplicate')
                      } else {
                        console.log(e);
                      }
                    })
                })
              })
          }

          list('/data/fitnessActivities', 20)

          // reqwest('data/fitnessActivities/:id')
          // .then(function(act){
          //   console.log("ACTIVITY", act);
          // })


          db
            .activities

            .where("userID").equals({{_id}})

            .sortBy("start_time_norm", function(items) {
              items.reverse();
              output.innerText = items.map(row).join('')
            });



            function row(i){
              return [
                  i.type,
                  (i.total_distance/1000).toPrecision(2) + 'km',
                  i.start_time,
                  i.uri
                ].join('\t') + '\n';
            }

        </script>
      {{/user}}

    </div>

  </body>
</html>
