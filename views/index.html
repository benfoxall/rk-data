<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Runkeeper to csv</title>
    <link rel="stylesheet" type="text/css" href="bower_components/bootstrap/dist/css/bootstrap.css">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style media="screen">
      .pulse { -webkit-animation: pulse 0.75s infinite alternate; -moz-animation: pulse 0.75s infinite alternate; -o-animation: pulse 0.75s infinite alternate; animation: pulse 0.75s infinite alternate; }
      @-webkit-keyframes pulse { from { opacity: 0.25; } to { opacity: 1; } }
      @-moz-keyframes pulse { from { opacity: 0.25; } to { opacity: 1; } }
      @-o-keyframes pulse { from { opacity: 0.25; } to { opacity: 1; } }
      @keyframes pulse { from { opacity: 0.25; } to { opacity: 1; } }
    </style>

  </head>
  <body>
    <a href="https://github.com/benfoxall/runkeeper-to-csv"><img style="position: absolute; top: 0; right: 0; border: 0;" src="gh.png" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>

    <div class="container">
      <div class="page-header">
        <h1>
          Runkeeper to csv
          <small>
          <a href="#settings" data-toggle="modal" data-target="#settings">
            <span class="glyphicon glyphicon-cog"></span>
          </a>
        </small>
        </h1>
      </div>
      <p class="lead">This fetches data from the <a href="http://developer.runkeeper.com/healthgraph">runkeeper healthgraph api</a> and converts it to csv documents</p>

      {{^user}}
        <p>
          <a href="/auth/runkeeper" class="btn btn-primary">sign in with runkeeper</a>
        </p>
      {{/user}}

      {{#user}}

        <div class="panel panel-default">
          <div class="panel-body">

            <h3>
              <img class="img-circle" src="/picture" width="72" height="72" >
              {{name}}
              <a class="btn btn-default btn-sm" href="/logout">sign out</a>
            </h3>

            <hr />

            <h1 id="status">
              <i class="glyphicon glyphicon-record"></i>
              <span>-</span>
            </h1>

            <hr />

            <p class="downloads">
              <a class="btn btn-default" href="#" id="download-summary">summary.csv</a>
              <a class="btn btn-default" href="#" id="download-distances">distances.csv</a>
              <a class="btn btn-default" href="#" id="download-paths">paths.csv</a>
              <span class="help-block">a partial file can be saved while fetching more data</span>
            </p>

          </div>
        </div>

        <!-- settings modal -->
        <div class="modal fade" id="settings">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title"><span class="glyphicon glyphicon-cog"></span></h4>
              </div>
              <div class="modal-body">
                <p class="lead">
                  Data from the api is stored in your browser to avoid re-downloading data from
                  the api
                </p>
                <div class="form-group">
                  <button class="btn btn-danger" data-action="clear">clear all data</button>
                </div>
                <p>
                  Note, this data will be removed when you log out
                </p>
              </div>
            </div>
          </div>
        </div>

        <script src="bower_components/jquery/dist/jquery.js"></script>
        <script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>

        <script type="text/javascript" src="bower_components/FileSaver/FileSaver.min.js"></script>
        <script type="text/javascript" src="bower_components/async/dist/async.min.js"></script>
        <script type="text/javascript" src="bower_components/reqwest/reqwest.min.js"></script>
        <script type="text/javascript" src="bower_components/dexie/dist/latest/Dexie.min.js"></script>

        <script src="db.js"></script>
        <script type="text/javascript">

          // the state of the page
          var paused;
          var uris = [];
          var downloaded = [];

          // Update the UI of the page
          function UI() {
            var total = uris.length;

            // could be incorrect (mis-matching urls)
            // though errors more obvious like this
            var sofar = downloaded.length;

            $('#status span').html(
              total == sofar ?
              (total + ' activities') :
              sofar + '/' + total + ' activities'
              + (paused ? '<small>paused</small>' : '')
            )

            $('#status i').attr('class',
              'glyphicon glyphicon-' + (
                  sofar < total ? 'download pulse' :
                  paused ? 'time' : 'ok-circle'
              )
            )

            $('.downloads .btn')
              .toggleClass('btn-default', sofar === 0)
              .toggleClass('btn-warning', sofar > 0 && sofar < total)
              .toggleClass('btn-success', sofar > 0 && sofar === total)
          }

          db.activities.toCollection().keys(function(keys){
            downloaded = downloaded.concat(keys);
            UI();
          })

          var q = async.queue(function (uri, callback) {
            db.activities
              .where('uri').equals(uri)
              .count(function(c){
                if(c === 0)
                  return populate(uri)
                    .then(function(){
                      downloaded.push(uri);
                      UI();
                    })
              })
              .then(callback)
          }, 2);

          function populate(uri){
            return reqwest('data' + uri)
                    .then(function(data){
                      return db.activities.put(data)
                    })
          }


          function populateIndex(url) {
            reqwest('/data' + url)
              .then(function(res){
                var items = res.items.map(function(item){
                  return item.uri;
                });
                uris = uris.concat(items);

                q.push(items);

                UI();
                if(res.next) populateIndex(res.next);
              })
          }

          populateIndex('/fitnessActivities');

          // todo - UI update
          $(document).on('click', '[data-action=clear]', function(){
            db.activities.clear()
            .then(function(){
              window.location.reload()
            })
          })

          document.getElementById('download-summary').addEventListener('click', function(e){
            e.preventDefault();

            console.time('export')

            var keys = ['uri', 'duration', 'type', 'start_time', 'total_distance', 'climb', 'total_calories'];
            var rows = [keys];

            db
              .activities
              .reverse()
              .each(function(activity){
                rows.push(
                  row(keys, activity)
                )
              })
              .then(function(){
                console.timeEnd('export');

                var b = new Blob(rows.map(function(row){
                  return csv(row) + '\n';
                }),  {type: 'text/csv'});

                saveAs(b, 'runkeeper-{{name}}-summary.csv')
              })


          }, false)



          document.getElementById('download-distances').addEventListener('click', function(e){
            e.preventDefault();

            console.time('export distances')

            var data = [new Blob(['uri, timestamp, distance\n'])];

            db
              .activities
              .reverse()
              .each(function(activity){
                data.push(
                  new Blob([activity.distance.map(function(d){
                    return csv([activity.uri, d.timestamp, d.distance])
                  }).join('\n') + '\n'])
                );
              })
              .then(function(){
                console.timeEnd('export distances');

                var b = new Blob(data,  {type: 'text/csv'});

                saveAs(b, 'runkeeper-{{name}}-distances.csv')
              })


          }, false)




          document.getElementById('download-paths').addEventListener('click', function(e){
            e.preventDefault();

            console.time('export paths')

            var data = [new Blob(['uri, timestamp, altitude, latitude, longitude\n'])];

            db
              .activities
              .reverse()
              .each(function(activity){
                data.push(
                  new Blob([activity.path.map(function(d){
                    return csv([activity.uri, d.timestamp, d.altitude, d.latitude, d.longitude])
                  }).join('\n') + '\n'])
                );
              })
              .then(function(){
                console.timeEnd('export paths');

                var b = new Blob(data,  {type: 'text/csv'});

                saveAs(b, 'runkeeper-{{name}}-paths.csv')
              })


          }, false)


          // pull out a row of keys
          function row(keys, obj){
            return keys.map(function(k){
              return obj[k]
            })
          }
          // create a csv row from an array
          function csv(array){

            // this is not a world class csv generator
            return array.map(function(item){
              return  typeof(item) === 'string' ?
                item.replace(/[\",]/g,'') :
                item;
            }).join(',')
          }

        </script>
      {{/user}}

    </div>



  </body>
</html>
