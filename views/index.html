<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Runkeeper to csv</title>
    <link rel="stylesheet" type="text/css" href="bower_components/bootstrap/dist/css/bootstrap.css">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style media="screen">
      .pulse { -webkit-animation: pulse 0.75s infinite alternate; -moz-animation: pulse 0.75s infinite alternate; -o-animation: pulse 0.75s infinite alternate; animation: pulse 0.75s infinite alternate; }
      @-webkit-keyframes pulse { from { opacity: 0.25; } to { opacity: 1; } }
      @-moz-keyframes pulse { from { opacity: 0.25; } to { opacity: 1; } }
      @-o-keyframes pulse { from { opacity: 0.25; } to { opacity: 1; } }
      @keyframes pulse { from { opacity: 0.25; } to { opacity: 1; } }
    </style>

  </head>
  <body>
    <a href="https://github.com/benfoxall/runkeeper-to-csv"><img style="position: absolute; top: 0; right: 0; border: 0;" src="gh.png" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>

    <div class="container">
      <div class="page-header">
        <h1>
          Runkeeper to csv
          <small>
          <a href="#settings" data-toggle="modal" data-target="#settings">
            <span class="glyphicon glyphicon-cog"></span>
          </a>
        </small>
        </h1>
      </div>
      <p class="lead">This fetches data from the <a href="http://developer.runkeeper.com/healthgraph">runkeeper healthgraph api</a> and converts it to csv documents</p>

      {{^user}}
        <p>
          <a href="/auth/runkeeper" class="btn btn-primary">sign in with runkeeper</a>
        </p>
      {{/user}}

      {{#user}}

        <div class="panel panel-default">
          <div class="panel-body">

            <h3>
              <img class="img-circle" src="/picture" width="72" height="72" >
              {{name}}
              <a class="btn btn-default btn-sm" href="/logout">sign out</a>
            </h3>

            <hr />

            <h1 id="status">
              <i class="glyphicon glyphicon-record"></i>
              <span><span id="sofar">-</span>/<span id="total">-</span></span>
            </h1>

            <hr />

            <p>

                <a class="btn btn-default" href="#" data-worker="resume">resume</a>

                <a class="btn btn-default" href="#" data-worker="pause">pause</a>
                <a class="btn btn-default" href="#" data-worker="echo">echo</a>
                <a class="btn btn-default" href="#" data-worker="clear">clear</a>

            </p>

            <hr />

            <p class="downloads">
              <a class="btn btn-default" href="sw/summary.csv" x-download target="_blank">summary.csv</a>
              <a class="btn btn-default" href="sw/distances.csv" x-download target="_blank">distances.csv</a>
              <a class="btn btn-default" href="sw/paths.csv" x-download target="_blank">paths.csv</a>
              <span class="help-block">a partial file can be saved while fetching more data</span>
            </p>

          </div>
        </div>

        <!-- settings modal -->
        <div class="modal fade" id="settings">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title"><span class="glyphicon glyphicon-cog"></span></h4>
              </div>
              <div class="modal-body">
                <p class="lead">
                  Data from the api is stored in your browser to avoid re-downloading data from
                  the api
                </p>
                <div class="form-group">
                  <button class="btn btn-danger" data-action="clear">clear all data</button>
                </div>
                <p>
                  Note, this data will be removed when you log out
                </p>
              </div>
            </div>
          </div>
        </div>

        <script src="bower_components/jquery/dist/jquery.js"></script>
        <script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>

        <script type="text/javascript" src="bower_components/FileSaver/FileSaver.min.js"></script>
        <script type="text/javascript" src="bower_components/async/dist/async.min.js"></script>
        <script type="text/javascript" src="bower_components/reqwest/reqwest.min.js"></script>
        <script type="text/javascript" src="bower_components/dexie/dist/latest/Dexie.min.js"></script>

        <!--script src="db.js"></script-->
        <script type="text/javascript">
          if ((!location.port || location.port == "80") && location.protocol != 'https:') {
            location.protocol = 'https:';
          }

          var worker = new Worker("worker.js");

          worker.onmessage = function(event) {
            if(event.data.total){
              document.getElementById('total').innerText = event.data.total;
              document.getElementById('sofar').innerText = event.data.sofar;
            }
            console.log("WINDOW>>", event.data)
          };

          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(function(registration) {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }).catch(function(err) {
              console.log('ServiceWorker registration failed: ', err);
            });
          }


          // find all of the urls that we'd like to have saved
          function index(url) {
            if(!url) return

            return fetch('/data' + url, { credentials: 'include' })
              .then(function(res){
                return res.json();
              })
              .then(function(json){

                worker.postMessage({
                  action: 'populate',
                  urls: json.items.map(function(item){
                    return item.uri;
                  })
                });

                return index(json.next)
              })
          }

          index('/fitnessActivities',[])


          $(document).on('click', '[data-worker]', function(){
            worker.postMessage({
              action:$(this).data('worker')
            })
          })

        </script>
      {{/user}}

    </div>



  </body>
</html>
